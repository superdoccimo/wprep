## WordPress URL置換スクリプト

**目的**: このスクリプトは、WordPressのデータベース内でURLを効率的に置換するためのツールです。WP-CLIが利用できない環境でも、手動でシリアライズされたデータも含めた安全なURL置換を行うことが可能です。

### 概要

このスクリプトは以下の機能を持っています。

- URLの置換：データベース内の古いURLを新しいURLに置換します。
- シリアライズされたデータの対応：シリアライズされたデータも適切に置換されます。
- Dry-run機能：実際に変更を加える前に、変更がどの程度行われるかを確認できます。
- 並列処理による高速化：複数のテーブルやカラムを効率的に処理します。
- 詳細なログ出力：置換の進行状況や結果を wpurl_replace.log ファイルに記録します。

### 使用方法

1. **環境変数の設定**  
   `.env`ファイルにデータベースの接続情報を記述します。

   ```bash
   DB_USER=username
   DB_PASSWORD=yourpassword
   DB_HOST=localhost
   DB_NAME=yourdbname
   ```
2. **スクリプトの実行**  
   `old-url` と `new-url` の引数を指定して、以下のコマンドを実行します。

   ```bash
   python wp-url-replace.py --old-url http://oldurl.com --new-url http://newurl.com
   ```
3. **Dry-runモード**  
   実際に変更を加える前に、`--dry-run` オプションを使用して変更のシミュレーションを行うことができます。

   ```bash
   python wp-url-replace.py --old-url http://oldurl.com --new-url http://newurl.com --dry-run
   ```

## エラーハンドリングの強化

エラーが発生した際には、スクリプトがどのように対処するかを確認し、ログにエラーメッセージを記録することが重要です。特に、MySQL接続エラーや置換処理のエラーに関する情報を記録しておくと、後で問題をトラブルシューティングしやすくなります。これにより、発生したエラーを正確に把握し、迅速に修正することが可能です。

## スクリプト実行の前提条件

スクリプトを実行する際の前提条件（例：Python、mysql-connector、dotenv、phpserializeなどのライブラリがインストールされていること、.envファイルの設定が完了していること）を忘れないで下さい。

## データのバックアップの重要性

スクリプトを実行する前に、必ずデータベースのバックアップを取得することを強くおすすめします。特に、操作ミスによるデータの損失を防ぐため、バックアップは重要です。初心者の方にとっても、データを安全に保護するための重要なステップとなりますので、バックアップの手順をしっかり確認してから進めてください。

### mysqldumpを使用したバックアップの例

以下のコマンドを使用して、データベースのバックアップを作成することができます。

   ```bash
   mysqldump -u ユーザー名 -p データベース名 > backup.sql
   ```
## 実行後の確認作業

スクリプトを実行した後は、データベース内の置換が正しく行われたかを確認することが重要です。特に、特定のテーブルやカラムに対して、クエリを使用して変更が適用されているかを検証する作業を行ってください。

### 確認の例

以下のようなSQLクエリを使って、置換が適切に行われたか確認できます。

   ```sql
   SELECT * FROM wp_options WHERE option_value LIKE '%新しいURL%';
   ```
   このクエリにより、wp_options テーブル内の option_value カラムに新しいURLが適切に置換されているかどうかを確認できます。
## セキュリティに関する注意

データベースにアクセスするスクリプトを使用する際は、セキュリティ面に十分注意を払うことが重要です。スクリプトやデータベースへの不正アクセスを防ぐため、以下のポイントを守りましょう。

- **スクリプトのパーミッション設定**  
  スクリプトファイルのパーミッションを適切に設定してください。外部からの不正アクセスを防ぐために、スクリプトの実行権限は必要最低限のユーザーに限定しましょう。
  
- **データベースユーザーの権限設定**  
  データベースに接続するユーザーには、必要最小限の権限を設定することが推奨されます。たとえば、データベースの読み取りや書き込みのみを許可し、管理権限（DROPやALTER権限など）は付与しないようにします。

これらのセキュリティ対策を講じることで、データやシステム全体の安全性を高め、セキュリティリスクを最小限に抑えることができます。






